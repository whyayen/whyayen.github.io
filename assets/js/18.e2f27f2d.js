(window.webpackJsonp=window.webpackJsonp||[]).push([[18],{502:function(t,s,a){"use strict";a.r(s);var e=a(4),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"前言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[t._v("#")]),t._v(" 前言")]),t._v(" "),a("p",[t._v("最近開發一個功能是將 ActiveStorage 上傳至 S3 的檔案，進行轉檔後，在將轉完的檔案 attach 回該 record，假設有一個 model 叫做 "),a("code",[t._v("User")]),t._v("，並且有兩個 ActiveStorage "),a("code",[t._v("has_one_attached")]),t._v(" 的欄位，一個是 "),a("code",[t._v("original_file")]),t._v("，另一個 "),a("code",[t._v("converted_file")]),t._v("，我可以透過 "),a("code",[t._v("User.original_file")]),t._v(" 及 "),a("code",[t._v("User.converted_file")]),t._v(" 抓到原始及轉檔後的檔案。")]),t._v(" "),a("p",[t._v("透過 ActiveStorage 上傳檔案到 GCP、S3 很簡單，官方文件寫的很清楚，但如果你的檔案是透過其他服務（轉檔服務）等放到 S3，而不是透過你本身的 Application 上傳，要如何把已經在 S3 的檔案關聯回 record 呢？下面透過 ActiveStorage source code 一步一步說明如何達到此需求。\b")]),t._v(" "),a("h2",{attrs:{id:"activestorage-原理"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#activestorage-原理"}},[t._v("#")]),t._v(" ActiveStorage 原理")]),t._v(" "),a("p",[t._v("在 "),a("a",{attrs:{href:"https://edgeguides.rubyonrails.org/active_storage_overview.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("ActiveStorage 文件"),a("OutboundLink")],1),t._v("中，並沒有提到如何把已經在 S3 的檔案，在綁回 model 中 ActiveStorage 的欄位，雖然在 StackOverflow 有找到解答，但並不清楚 ActiveStorage 的運作方式，所以也不明白為何要這麼寫，因此了解 ActiveStorage 的原理才能知道為何要這麼寫！")]),t._v(" "),a("p",[t._v("以下將以 Rails v5.2.0 版來解析 ActiveStorage 原理，Storage Service 也都會以 S3 為主（當然其他 Service 也大同小異），其程式碼可以參考此"),a("a",{attrs:{href:"https://github.com/rails/rails/tree/v5.2.0/activestorage",target:"_blank",rel:"noopener noreferrer"}},[t._v("連結"),a("OutboundLink")],1),t._v("。")]),t._v(" "),a("h3",{attrs:{id:"資料表結構"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#資料表結構"}},[t._v("#")]),t._v(" 資料表結構")]),t._v(" "),a("p",[t._v("從 "),a("a",{attrs:{href:"https://github.com/rails/rails/blob/v5.2.0/activestorage/db/migrate/20170806125915_create_active_storage_tables.rb",target:"_blank",rel:"noopener noreferrer"}},[t._v("migrations"),a("OutboundLink")],1),t._v(" 可以發現 ActiveStorage 新增 2 張資料表")]),t._v(" "),a("div",{staticClass:"language-Ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[t._v("create_table "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":active_storage_blobs")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("do")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n  t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("string   "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("        null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n  t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("string   "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":filename")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("   null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n  t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("string   "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":content_type")]),t._v("\n  t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("text     "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":metadata")]),t._v("\n  t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("bigint   "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":byte_size")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("  null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n  t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("string   "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":checksum")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("   null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n  t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("datetime "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":created_at")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n\n  t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("index "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":key")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" unique"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n\ncreate_table "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":active_storage_attachments")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("do")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("t"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n  t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("string     "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("     null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n  t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("references "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":record")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("   null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" polymorphic"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" index"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n  t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("references "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":blob")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("     null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n\n  t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("datetime "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":created_at")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),t._v("\n\n  t"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("index "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":record_type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":record_id")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":blob_id")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" name"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"index_active_storage_attachments_uniqueness"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" unique"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br")])]),a("ul",[a("li",[a("code",[t._v("active_storage_blobs")]),t._v(": 儲存檔案相關內容\n"),a("ul",[a("li",[a("code",[t._v("key")]),t._v(": 存在 Service 上的名稱，如：S3 上檔案的 key")]),t._v(" "),a("li",[a("code",[t._v("filename")]),t._v(": 原始（上傳時）的檔案名稱")]),t._v(" "),a("li",[a("code",[t._v("content_type")]),t._v(": 檔案的 Content Type (Media Type)")]),t._v(" "),a("li",[a("code",[t._v("metadata")]),t._v(": 一些 metadata")]),t._v(" "),a("li",[a("code",[t._v("byte_size")]),t._v(": 檔案大小")]),t._v(" "),a("li",[a("code",[t._v("checksum")]),t._v(": 用來檢查檔案送到 Service 後，與當初計算的是正確（同個檔案）")])])]),t._v(" "),a("li",[a("code",[t._v("active_storage_attachments")]),t._v(": 儲存關聯的 Model 及 Blob\n"),a("ul",[a("li",[a("code",[t._v("name")]),t._v(": Model 的 ActiveStorage 欄位名稱，如："),a("code",[t._v("original_file")])]),t._v(" "),a("li",[a("code",[t._v("record_type")]),t._v(": Model 名稱，如："),a("code",[t._v("User")])]),t._v(" "),a("li",[a("code",[t._v("record_id")]),t._v(": 關聯 Model 的 "),a("code",[t._v("id")])]),t._v(" "),a("li",[a("code",[t._v("blob_id")]),t._v(": 關聯 Blob 的 "),a("code",[t._v("id")])])])])]),t._v(" "),a("p",[t._v("這裡比較難懂的應該是 "),a("code",[t._v("checksum")]),t._v("，自己當初有點好奇為何需要 "),a("code",[t._v("checksum")]),t._v("（抱歉，我菜QQ）。\n我們來看一下 ActiveStorage upload 做了什麼事情")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/rails/rails/blob/v5.2.0/activestorage/app/models/active_storage/blob.rb#L139",target:"_blank",rel:"noopener noreferrer"}},[t._v("activestorage/app/models/active_storage/blob.rb"),a("OutboundLink")],1)]),t._v(" "),a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[t._v("  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Prior to uploading, we compute the checksum, which is sent to the service for transit integrity validation. If the")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# checksum does not match what the service receives, an exception will be raised. We also measure the size of the +io+")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# and store that in +byte_size+ on the blob record.")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Normally, you do not have to call this method directly at all. Use the factory class methods of +build_after_upload+")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# and +create_after_upload!+.")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token method-definition"}},[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("upload")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("self")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("checksum     "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" compute_checksum_in_chunks"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("self")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("content_type "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" extract_content_type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("self")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("byte_size    "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("size\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("self")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("identified   "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n\n    service"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("upload"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" checksum"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" checksum"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br")])]),a("blockquote",[a("p",[t._v("Prior to uploading, we compute the checksum, which is sent to the service for transit integrity validation.")])]),t._v(" "),a("p",[t._v("仔細看第一行註解，這裡有敘述 upload 實作的詳細過程，而也提到 "),a("code",[t._v("checksum")]),t._v(" 扮演的角色。\n接著我們來看 S3 這個 Service upload 是如何實作的吧")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/rails/rails/blob/v5.2.0/activestorage/lib/active_storage/service/s3_service.rb",target:"_blank",rel:"noopener noreferrer"}},[t._v("active_storage/service/s3_service.rb"),a("OutboundLink")],1)]),t._v(" "),a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token method-definition"}},[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("upload")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" checksum"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("nil")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  instrument "),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":upload")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" checksum"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" checksum "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("do")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("begin")]),t._v("\n      object_for"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("put"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("upload_options"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("merge"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("body"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" content_md5"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" checksum"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("rescue")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Aws")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("S3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Errors")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("BadDigest")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("raise")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ActiveStorage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("IntegrityError")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br")])]),a("p",[t._v("簡單來說就是上傳前我們會對檔案做計算，會產生一組 MD5 的 hash，上傳時會把 "),a("code",[t._v("checksum")]),t._v(" 也給 S3，S3 收到檔案後一樣會做計算，如果與 "),a("code",[t._v("checksum")]),t._v(" 不同，則會 raise "),a("code",[t._v("Aws::S3::Errors::BadDigest")]),t._v("，以此去避免檔案內容損壞、竄改。")]),t._v(" "),a("p",[t._v("可參考：")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://docs.aws.amazon.com/sdk-for-ruby/v2/api/Aws/S3/Object.html#put-instance_method",target:"_blank",rel:"noopener noreferrer"}},[t._v("S3 v2 SDK for ruby - \b#put"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://aws.amazon.com/tw/premiumsupport/knowledge-center/data-integrity-s3/",target:"_blank",rel:"noopener noreferrer"}},[t._v("How can I check the integrity of an object uploaded to Amazon S3?"),a("OutboundLink")],1)])]),t._v(" "),a("h3",{attrs:{id:"建立檔案已經在-s3-上的-blob"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#建立檔案已經在-s3-上的-blob"}},[t._v("#")]),t._v(" 建立檔案已經在 S3 上的 Blob")]),t._v(" "),a("p",[t._v("\b雖然 ActiveStorage 的 Tutorial 內沒寫，不過在 API Docs 跟 ActiveStorage Source Code 有說明如何建立一個已經上傳的 Blob。")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/rails/rails/blob/v5.2.0/activestorage/app/models/active_storage/blob.rb#L3",target:"_blank",rel:"noopener noreferrer"}},[t._v("activestorage/app/models/active_storage/blob.rb#L3"),a("OutboundLink")],1)]),t._v(" "),a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# A blob is a record that contains the metadata about a file and a key for where that file resides on the service.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Blobs can be created in two ways:")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 1. Subsequent to the file being uploaded server-side to the service via <tt>create_after_upload!</tt>.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 2. Ahead of the file being directly uploaded client-side to the service via <tt>create_before_direct_upload!</tt>.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# The first option doesn't require any client-side JavaScript integration, and can be used by any other back-end")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# service that deals with files. The second option is faster, since you're not using your own server as a staging")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# point for uploads, and can work with deployments like Heroku that do not provide large amounts of disk space.")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br")])]),a("p",[t._v("根據註解說明：如果檔案已經被上傳到 Service，則可以透過 "),a("code",[t._v("create_before_direct_upload!")]),t._v(" 建立 Blob，那麼我們就來直接看 "),a("code",[t._v("create_before_direct_upload!")]),t._v(" 的實作。")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/rails/rails/blob/v5.2.0/activestorage/app/models/active_storage/blob.rb#L64",target:"_blank",rel:"noopener noreferrer"}},[t._v("activestorage/app/models/active_storage/blob.rb#L64"),a("OutboundLink")],1)]),t._v(" "),a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Returns a saved blob _without_ uploading a file to the service. This blob will point to a key where there is")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# no file yet. It's intended to be used together with a client-side upload, which will first create the blob")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# in order to produce the signed URL for uploading. This signed URL points to the key generated by the blob.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Once the form using the direct upload is submitted, the blob can be associated with the right record using")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# the signed ID.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token method-definition"}},[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("create_before_direct_upload")])]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" byte_size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" checksum"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" content_type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("nil")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("nil")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  create"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v(" filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" byte_size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" byte_size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" checksum"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" checksum"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" content_type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" content_type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" metadata"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" metadata\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br")])]),a("p",[t._v("我們發現建立一個 Blob 至少需要 "),a("code",[t._v("filename")]),t._v("、"),a("code",[t._v("byte_size")]),t._v("、"),a("code",[t._v("checksum")]),t._v("，而這三個除了 "),a("code",[t._v("checksum")]),t._v("，其他我們都可以透過 S3 "),a("code",[t._v("get_object")]),t._v(" 拿到資料，而 "),a("code",[t._v("checksum")]),t._v(" 我們則需要實作計算的方式，我是直接 copy Blob 內的 private 方法 "),a("code",[t._v("compute_checksum_in_chunks")]),t._v(" 來實作。")]),t._v(" "),a("p",[t._v("接下來讓我們自己來實作建立一個檔案已經存放在 S3 的 Blob 吧：")]),t._v(" "),a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token method-definition"}},[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("compute_checksum_in_chunks")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Digest")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("MD5")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("tap "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("do")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("checksum"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("|")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" chunk "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("read"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("5.")]),t._v("megabytes"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n      checksum "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" chunk\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n\n    io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("rewind\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("base64digest\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token method-definition"}},[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("create_blob")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("s3_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  s3 "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Aws")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("S3")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Client")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("region"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'us-west-1'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  converted_file "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" s3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("get_object"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("bucket"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'example-bucket'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" s3_key"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n  blob_params "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"change_your_filename.pdf"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    content_type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" converted_file"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("content_type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    byte_size"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" converted_file"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("content_length"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n    checksum"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" compute_checksum_in_chunks"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("converted_file"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("body"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n  blob "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ActiveStorage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Blob")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("create_before_direct_upload"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("blob_params"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  blob"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("update_attributes key"),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":s3_key")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" blob\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br"),a("span",{staticClass:"line-number"},[t._v("18")]),a("br"),a("span",{staticClass:"line-number"},[t._v("19")]),a("br"),a("span",{staticClass:"line-number"},[t._v("20")]),a("br"),a("span",{staticClass:"line-number"},[t._v("21")]),a("br"),a("span",{staticClass:"line-number"},[t._v("22")]),a("br"),a("span",{staticClass:"line-number"},[t._v("23")]),a("br"),a("span",{staticClass:"line-number"},[t._v("24")]),a("br"),a("span",{staticClass:"line-number"},[t._v("25")]),a("br"),a("span",{staticClass:"line-number"},[t._v("26")]),a("br")])]),a("p",[t._v("這邊有一點值得注意的是：建立一個 Blob 時，Blob 會自己產生一個 "),a("code",[t._v("key")]),t._v("，但這組 "),a("code",[t._v("key")]),t._v(" 並不是 S3 上檔案的 "),a("code",[t._v("key")]),t._v("，因此我們需要透過 "),a("code",[t._v("update_attributes")]),t._v(" 去改 "),a("code",[t._v("key")]),t._v(" 參數。")]),t._v(" "),a("p",[t._v("關於 key 的實作，可以看一下 Blob 內的實作：")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/rails/rails/blob/v5.2.0/activestorage/app/models/active_storage/blob.rb#L83",target:"_blank",rel:"noopener noreferrer"}},[t._v("activestorage/app/models/active_storage/blob.rb#L83"),a("OutboundLink")],1)]),t._v(" "),a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Returns the key pointing to the file on the service that's associated with this blob. The key is in the")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# standard secure-token format from Rails. So it'll look like: XTAPjJCJiuDrLk3TmwyJGpUo. This key is not intended")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# to be revealed directly to the user. Always refer to blobs using the signed_id or a verified form of the key.")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token method-definition"}},[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("key")])]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# We can't wait until the record is first saved to have a key for it")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("self")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),a("span",{pre:!0,attrs:{class:"token symbol"}},[t._v(":key")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("||")]),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("self")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("generate_unique_secure_token\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br")])]),a("p",[t._v("到這裡為止，我們已經可以透過 "),a("code",[t._v("create_blob")]),t._v(" 這個方法丟入 "),a("code",[t._v("s3_key")]),t._v(" 給他，然後我們會得到建立好的 Blob，這時候我們可以直接更新 ActiveStorage 設定的那個欄位（這裡以 "),a("code",[t._v("has_one_attached")]),t._v(" 的欄位 "),a("code",[t._v("converted_file")]),t._v(" 做示範）。")]),t._v(" "),a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[t._v("converted_blob "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" create_blob"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'converted/example_s3_file_key'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\nuser "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("User")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("find"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 直接餵 blob")]),t._v("\nuser"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("update"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("converted_file"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" converted_blob"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 或者餵 blob 的 signed_id")]),t._v("\nuser"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("update"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("converted_file"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" converted_blob"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("signed_id"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br")])]),a("p",[t._v("這樣就實作完了，把已經在 S3 上的檔案，關聯回 Rails 的 record 了，至於 "),a("code",[t._v("update")]),t._v(" 時要餵 Blob 或 Blob 的 "),a("code",[t._v("signed_id")]),t._v(" 其實都可以，這邊會特別拿出來說明是因為當時 "),a("a",{attrs:{href:"https://stackoverflow.com/questions/52323977/rails-activestorage-attachment-to-existing-s3-file",target:"_blank",rel:"noopener noreferrer"}},[t._v("StackOverflow 的範例"),a("OutboundLink")],1),t._v("只有 signed_id，困惑了我很久，不過這裡有找到相關的原始碼（此處以 "),a("code",[t._v("has_one_attached")]),t._v(" 來說明）：")]),t._v(" "),a("p",[a("a",{attrs:{href:"https://github.com/rails/rails/blob/v5.2.0/activestorage/lib/active_storage/attached/one.rb#L16",target:"_blank",rel:"noopener noreferrer"}},[t._v("activestorage/lib/active_storage/attached/one.rb#L16"),a("OutboundLink")],1)]),t._v(" "),a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token method-definition"}},[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("attach")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("attachable"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  blob_was "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" blob "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" attached"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?")]),t._v("\n  blob "),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" create_blob_from"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("attachable"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br")])]),a("p",[a("a",{attrs:{href:"https://github.com/rails/rails/blob/v5.2.0/activestorage/lib/active_storage/attached.rb#L18",target:"_blank",rel:"noopener noreferrer"}},[t._v("activestorage/lib/active_storage/attached.rb#L18"),a("OutboundLink")],1)]),t._v(" "),a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("def")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token method-definition"}},[a("span",{pre:!0,attrs:{class:"token function"}},[t._v("create_blob_from")])]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("attachable"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("case")]),t._v(" attachable\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("when")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ActiveStorage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Blob")]),t._v("\n    attachable\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("when")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ActionDispatch")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Http")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("UploadedFile")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Rack")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Test")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("UploadedFile")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ActiveStorage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Blob")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("create_after_upload"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v(" \\\n      io"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" attachable"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("open"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" attachable"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("original_filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n      content_type"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" attachable"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("content_type\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("when")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("Hash")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ActiveStorage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Blob")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("create_after_upload"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("attachable"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("when")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token builtin"}},[t._v("String")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("ActiveStorage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),a("span",{pre:!0,attrs:{class:"token constant"}},[t._v("Blob")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("find_signed"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("attachable"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("else")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("nil")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("end")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br"),a("span",{staticClass:"line-number"},[t._v("11")]),a("br"),a("span",{staticClass:"line-number"},[t._v("12")]),a("br"),a("span",{staticClass:"line-number"},[t._v("13")]),a("br"),a("span",{staticClass:"line-number"},[t._v("14")]),a("br"),a("span",{staticClass:"line-number"},[t._v("15")]),a("br"),a("span",{staticClass:"line-number"},[t._v("16")]),a("br"),a("span",{staticClass:"line-number"},[t._v("17")]),a("br")])]),a("p",[t._v("這裡可發現你餵的 "),a("code",[t._v("attachable")]),t._v(" 會檢查是什麼，如果是 "),a("code",[t._v("String")]),t._v(" 則會以 "),a("code",[t._v("signed_id")]),t._v(" 去做存取，如果是 "),a("code",[t._v("Blob")]),t._v(" 則會直接寫 attachable，註解表示可以餵 4 種類型的參數：")]),t._v(" "),a("div",{staticClass:"language-ruby line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-ruby"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   person.avatar.attach(params[:avatar]) # ActionDispatch::Http::UploadedFile object")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   person.avatar.attach(params[:signed_blob_id]) # Signed reference to blob from direct upload")]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v('#   person.avatar.attach(io: File.open("/path/to/face.jpg"), filename: "face.jpg", content_type: "image/jpg")')]),t._v("\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#   person.avatar.attach(avatar_blob) # ActiveStorage::Blob object")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[t._v("不過我並沒有去探究 "),a("code",[t._v("update!")]),t._v(" 方法到 "),a("code",[t._v("attach")]),t._v(" 中間過程的程式碼跟實現方式，這裡我並沒有辦法很確定是不是直接關聯到這，但 "),a("code",[t._v("update!")]),t._v(" 存取時餵 "),a("code",[t._v("Blob")]),t._v(" 或 "),a("code",[t._v("Blob 的 signed_id")]),t._v(" 我測試過是可行的。")]),t._v(" "),a("h2",{attrs:{id:"參考資料"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#參考資料"}},[t._v("#")]),t._v(" 參考資料")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://stackoverflow.com/questions/52323977/rails-activestorage-attachment-to-existing-s3-file",target:"_blank",rel:"noopener noreferrer"}},[t._v("Rails ActiveStorage attachment to existing S3 file"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/rails/rails/tree/v5.2.0/activestorage",target:"_blank",rel:"noopener noreferrer"}},[t._v("Rails ActiveStorage"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=n.exports}}]);