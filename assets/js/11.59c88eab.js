(window.webpackJsonp=window.webpackJsonp||[]).push([[11],{503:function(s,t,e){"use strict";e.r(t);var a=e(4),n=Object(a.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("h2",{attrs:{id:"前言"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#前言"}},[s._v("#")]),s._v(" 前言")]),s._v(" "),e("p",[s._v("最近開始使用 "),e("a",{attrs:{href:"https://github.com/beancount/beancount",target:"_blank",rel:"noopener noreferrer"}},[s._v("Beancount"),e("OutboundLink")],1),s._v(" 作帳，除了有日記帳，還能產資產負債表、損益表，不過是使用文字記帳，沒有資料庫等服務，而好處是可以做版本控制，所以希望在自己 Server 上，建立一個 Git Remote Repository 給我的其他設備可以同步 Beancount 帳本資料。")]),s._v(" "),e("p",[s._v("因為帳務資料較為私密的資料，不希望存放在 GitHub 之類，決定自己架台 Git Server，所以開一台在 Private Subnet 的 EC2 當 Git Server。")]),s._v(" "),e("h2",{attrs:{id:"vpc-架構"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#vpc-架構"}},[s._v("#")]),s._v(" VPC 架構")]),s._v(" "),e("p",[s._v("建立一個 VPC 包含：")]),s._v(" "),e("ul",[e("li",[s._v("1 個 Public Subnet")]),s._v(" "),e("li",[s._v("1 個 Private Subnet")])]),s._v(" "),e("p",[s._v("架構上有點像是下面這張圖，只是是單 AZ（Availability Zone）：\n"),e("img",{attrs:{src:"https://d1.awsstatic.com/partner-network/QuickStart/datasheets/linux-bastion-architecture.584765ff724625db9ab0d91a8ccb1c2eb7e15a5b.png",alt:"AWS - Linux Bastion Architecture"}})]),s._v(" "),e("p",[s._v("所以大致上就是像上圖的左半部一樣，Public Subnet 指到一個 Internet Gateway，然後起一台 EC2 當 Linux Bastion 放在 Public Subnet，然後開 22 port 給自己連（沒設定任何 Auto Scaling、EIP），甚至這台 EC2 我都用 Spot Instance，反正一天連一次，instance 沒了再開就好，但 spot 的價格讓我比較負擔的起。")]),s._v(" "),e("p",[s._v("接著再起一台 EC2 當存放 Git Remote Repository 的機器，放在 Private Subnet 並允許此 VPC 內的機器可以透過 SSH 連線進來，至少 Bastion 那台要能連線進來。")]),s._v(" "),e("h2",{attrs:{id:"建立-git-remote-repository"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#建立-git-remote-repository"}},[s._v("#")]),s._v(" 建立 Git Remote Repository")]),s._v(" "),e("p",[s._v("當兩台機器 (Bastion、Git Server) 開好之後，可以先透過 SSH 連線到 Bastion 再連線到 Git Server 看連線是否正常（可用 SSH Agent 等方式節省連線繁瑣的程序），如果無法連線，可能 VPC 的設定有錯誤。")]),s._v(" "),e("p",[s._v("接著我們進到 Git Server 進行 Git 設定，可以參考 Pro Git "),e("a",{attrs:{href:"https://git-scm.com/book/en/v2/Git-on-the-Server-Setting-Up-the-Server",target:"_blank",rel:"noopener noreferrer"}},[s._v("4.4 Git on the Server - Setting Up the Server"),e("OutboundLink")],1),s._v(" 的步驟做。")]),s._v(" "),e("p",[e("strong",[s._v("建立 git user")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Git Server")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" adduser "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("su")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" .ssh "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("700")]),s._v(" .ssh\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("touch")]),s._v(" .ssh/authorized_keys "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("chmod")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("600")]),s._v(" .ssh/authorized_keys\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[e("strong",[s._v("把你的 Public Key 放入 authorized_keys")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Git Server")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /tmp/id_rsa.john.pub "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" ~/.ssh/authorized_keys\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /tmp/id_rsa.josie.pub "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" ~/.ssh/authorized_keys\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("cat")]),s._v(" /tmp/id_rsa.jessica.pub "),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">>")]),s._v(" ~/.ssh/authorized_keys\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br")])]),e("p",[e("strong",[s._v("建立 remote repository")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Git Server")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" /home/git\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("mkdir")]),s._v(" project.git\n"),e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" project.git\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" init --bare\nInitialized empty Git repository "),e("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" /srv/git/project.git/\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("截至目前為止 remote repository 已經建好了，上述步驟相當於你在 GitHub 建立一個 Repository。")]),s._v(" "),e("h2",{attrs:{id:"設定-ssh-連線"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#設定-ssh-連線"}},[s._v("#")]),s._v(" 設定 SSH 連線")]),s._v(" "),e("p",[s._v("透過編輯 "),e("code",[s._v(".ssh/config")]),s._v(" 的方式我們可以簡單的直接連線到 Git Server，不用自己先連到 Bastion 再連到 Git Server。")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 你的電腦")]),s._v("\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("vim")]),s._v(" ~/.ssh/config\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("假設我們兩台機器的 IP:")]),s._v(" "),e("ul",[e("li",[s._v("Bastion: "),e("code",[s._v("35.174.52.219")]),s._v(" (Public IPv4)")]),s._v(" "),e("li",[s._v("Git Server: "),e("code",[s._v("192.168.0.34")]),s._v(" (Private IPv4)")])]),s._v(" "),e("p",[s._v("我們的 "),e("code",[s._v(".ssh/config")]),s._v(" 如下：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("Host 35.174.52.219\n    HostName 35.174.52.219\n    User ec2-user\n    IdentityFile /your/ec2/key_path.pem\n\nHost 192.168.0.34\n    HostName 192.168.0.34\n    User ec2-user\n    IdentityFile /your/ec2/key_path.pem\n    ProxyCommand ssh -W %h:%p 35.174.52.219\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[s._v("存檔後，便可直接透過 "),e("code",[s._v("ssh 192.168.0.34")]),s._v(" 連線到 Git Server，後面設定 Git Remote 後，也才能透過 Git Push 將我們 local 的 repository 同步到 remote repository。")]),s._v(" "),e("h2",{attrs:{id:"設定-project-的-remote"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#設定-project-的-remote"}},[s._v("#")]),s._v(" 設定 Project 的 remote")]),s._v(" "),e("p",[s._v("接著我們回到 local 的 repository")]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v("cd")]),s._v(" ~/development/your_project\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" remote "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("add")]),s._v(" origin git@192.168.0.34:/home/git/project.git\n"),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" push origin master\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("應該就能成功了：")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("Counting objects: 4, done.\nDelta compression using up to 12 threads.\nCompressing objects: 100% (2/2), done.\nWriting objects: 100% (4/4), 528 bytes | 528.00 KiB/s, done.\nTotal 4 (delta 1), reused 0 (delta 0)\nTo 192.168.0.34:/home/git/beancount.git\n   0365711..5ecceb5  master -> master\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br")])]),e("h2",{attrs:{id:"參考資料"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#參考資料"}},[s._v("#")]),s._v(" 參考資料")]),s._v(" "),e("ul",[e("li",[e("a",{attrs:{href:"https://git-scm.com/book/en/v2/Git-on-the-Server-Setting-Up-the-Server",target:"_blank",rel:"noopener noreferrer"}},[s._v("Pro Git"),e("OutboundLink")],1)]),s._v(" "),e("li",[e("a",{attrs:{href:"https://stackoverflow.com/questions/32654857/git-clone-issues-via-an-ssh-proxied-host?fbclid=IwAR3SvXOobzGk14H8nc3Mxc_Er5Tiz6wC6izz2AtNiakBpV2DpHCs97l5idk",target:"_blank",rel:"noopener noreferrer"}},[s._v("git clone issues via an SSH proxied host"),e("OutboundLink")],1)]),s._v(" "),e("li",[e("a",{attrs:{href:"https://www.cyberciti.biz/faq/linux-unix-ssh-proxycommand-passing-through-one-host-gateway-server/",target:"_blank",rel:"noopener noreferrer"}},[s._v("SSH ProxyCommand example: Going through one host to reach another server"),e("OutboundLink")],1)])])])}),[],!1,null,null,null);t.default=n.exports}}]);